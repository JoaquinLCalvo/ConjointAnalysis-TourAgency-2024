---
title: "project_report"
format: html
editor: visual
---

```{r}
#| echo: false

# The `echo: false` option disables the printing of code (only output is displayed).

# Load the packages
library(tidyverse)
library(mlogit)
library(DataExplorer)
library(ggplot2)
library(skimr)
library(dplyr)
library(MASS)

```

```{r}
#| echo: false

# Load the data
vacation <- read.csv("./CBC_Vacation_data.csv", header = TRUE, sep = ";")
View(vacation)

```

```{R}
#### 1- Exploratory Data Analysis EDA ####

# Check the data
head(vacation)
summary(vacation)
skim(vacation)

# Check for missing values
sum(is.na(vacation))

# Visualize Distributions of Numerical Variables
vacation %>%
  select_if(is.numeric) %>%
  gather() %>%
  ggplot(aes(value)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  facet_wrap(~key, scales = "free") +
  theme_minimal()
# The variables are not numeric, no point in this plot

# Number of respondents = 250
length(unique(vacation$resp.id))

# Number of questions per respondent = 18
table(vacation$resp.id) / 4

# Distribution of the response variable
table(vacation$alt[vacation$choice == 1]) # A bit left-sweked, right? 
#it's balanced between the 4 options more or less (so no weird behavior)

# Check the frequencies of attributes
sapply(vacation[, 4:8], table) #it's balanced

# Check the levels of the attributes
sapply(vacation[, 4:8], unique)
# 432 unique combinations of attributes

# Covert to factor
vacation$Price <- as.factor(vacation$Price)
vacation$Duration <- as.factor(vacation$Duration)
vacation$Accommodation <- factor(vacation$Accommodation,
                                 levels = c("budget", "3stars", "5stars"))
vacation$Transport <- as.factor(vacation$Transport)
vacation$Destination <- as.factor(vacation$Destination)

# Visualize Distributions of Categorical Variables
vacation %>%
  select_if(is.factor) %>%
  gather() %>%
  ggplot(aes(value)) +
  geom_bar(fill = "skyblue", color = "black") +
  facet_wrap(~key, scales = "free") +
  geom_text(stat = "count", aes(label = ..count..), vjust = 1.5, color = "white", size = 4) +
  xlab("") +
  ylab("Count") +
  theme_minimal()


# Create the design matrix
vacation_mlogit <- dfidx(vacation, idx = list(c("ques", "resp.id"), "alt"))
vacation_mlogit



```

## 1. Introduction

Understanding consumer preferences is crucial for designing products and services that resonate with target audiences. Conjoint analysis is a widely used method for modeling decision-making processes, enabling researchers to quantify the importance of different product attributes and the trade-offs consumers are willing to make. By presenting respondents with hypothetical scenarios, this approach allows for a detailed exploration of how specific features influence choices.

This project focuses on vacation planning, a domain where consumer decisions are influenced by a range of factors, including price, duration, accommodation, transport, and destination. The goal of the analysis is to identify the key drivers of consumer preferences for vacation packages and to provide actionable insights for the travel and tourism industry. These insights can help businesses design offerings that better meet the needs and expectations of potential customers.

## 2. Data Collection and Methodology

The dataset for this study was provided by the course professor and is specifically designed to simulate consumer decision-making in vacation planning. It is organized in a long format, a standard structure for Choice-Based Conjoint (CBC) analysis, where:

-   **Respondent ID (`resp.id`)**: Identifies each participant.

-   **Choice Task ID (`ques`)**: Identifies each decision-making scenario (choice task) presented to respondents.

-   **Alternative ID (`alt`)**: Represents each vacation package alternative within a choice task.

-   **Attributes and Levels**:

    -   **Price**: Cost of the package (`$500`, `$800`, `$1500`, `$2500`).

    -   **Duration**: Vacation length (e.g., `2 days`, `5 days`, `10 days`).

    -   **Accommodation**: Type of lodging (`budget`,`3-stars`, `5-stars`).

    -   **Transport**: Mode of transport (`bus`, `train`, `plane`).

    -   **Destination**: Vacation destination (`Greece`, `Turkey`,`Portugal`, `Spain`).

-   **Choice Indicator (`choice`)**: A binary variable showing whether an alternative was selected (`1`) or not (`0`).

Each respondent faced multiple choice tasks, with each task consisting of several vacation package alternatives. Respondents selected their preferred package in each task, and only one alternative per task is marked as chosen. This structure is well-suited for CBC analysis, which directly models such decision-making processes.

```{r,echo=FALSE}
# Load required packages
library(knitr)
library(kableExtra)

# Display the first six entries in an aesthetic table
kable(head(vacation, 10), format = "html", table.attr = "style='width:70%; margin:auto;'") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

### Maybe add an analysis like on slide 8\~10

## 4. Data Description (Borto)

-   Summary statistics of the data (optional if meaningful).

## 5. - Model Fitting (Ricardo)

This study aims to examine the relationship between consumer choice and product attributes, focusing on understanding why a consumer selects a particular package based on the characteristics of the options presented. To achieve this, we employ a discrete choice model, specifically a multinomial logit regression.

We begin by assessing the dataset, which captures respondents' choices among four available alternatives. The dependent variable, *choice*, is a categorical variable with four levels. To appropriately model this type of data, we utilize a Multinomial Logit Model (MNL).

On an initial light analysis, the summary for our first model `model1` has intuitive responses. As the price increases, the estimate for the attribute `Price` gains a more negative value. A deeper analysis is performed in the Results and Interpretations section.

The alternative-specific constants represent preferences for the positions of the alternatives within each question. Specifically, the parameters `(Intercept):2`, `(Intercept):3`, and `(Intercept):4` quantify the preference for each position from left to right relative to the first position on the left.

The estimated MNL model indicates that these intercepts are very small and not statistically significant. To improve model parsimony and precision, we have chosen to exclude these intercepts from the analysis, thereby reducing the degrees of freedom.

```{r,echo=FALSE}
model1 <- mlogit(choice ~ Price + Duration + Accommodation +
                   Transport + Destination,
                 data = vacation_mlogit)
summary(model1)
```

We formally evaluate the decision to remove the intercepts using a likelihood ratio test. This involves comparing the larger model `model1`, which includes the intercepts, with the smaller model `model2` that excludes them.

The comparison between the full model and the reduced model without intercepts yields a p-value of `0.7185` . Given this high p-value, we conclude that there is no significant difference in goodness of fit between the two models, indicating that both explain the data equally well. Consequently, the alternative-specific constants are not essential for adequately modeling the data.

```{r,echo=FALSE}
# Fit the model without intercept parameters
model2 <- mlogit(choice ~ Price + Duration + Accommodation +
                   Transport + Destination | -1,
                 data = vacation_mlogit)
summary(model2)

# Likelihood ratio test
lrtest(model2, model1)
```

We continue to explore opportunities to simplify the model. In the previous analysis, the attribute *price* was treated as a qualitative variable. We now incorporate it as a quantitative predictor in order to understand if the the model's efficiency and interpretability is enhanced.

```{r,echo=FALSE}
# Fit the model without intercept and price as a quantitative variable
model3 <- mlogit(choice ~ as.numeric(as.character(Price)) +
                   Duration + Accommodation + Transport + Destination | -1,
                 data = vacation_mlogit)
summary(model3)
lrtest(model3, model2)
```

Again, we formally evaluate the decision to transform the attribute from quantitative, to quantitative, using a likelihood ratio test. The null hypothesis for the likelihood ratio test for the comparison between `model2` and `model3` asserts that the simpler model (Model 2) is sufficient, and that the added complexity of Model 3 does not result in a significant improvement in model fit. Given the extremely low p-value, we reject the null hypothesis and select Model 2 over Model 3.

## 6. Results and Interpretations (Ricardo)

-   Discussion of the results:
    -   Key insights into consumer preferences.
    -   Relationships between attributes and consumer choices.

### Interpretation of the selected model (model2).

The selected model reveals preferences among the respondents. We observe a clear price sensitivity, as the prices increase, the likelihood of selection decreases. Regarding the duration of the offered options, the most favored option is a short 2 night trip, followed by a longer 10 night trip. The intermediate 5 day trip is the least preferred. Accommodation preferences show a strong inclination towards 5-star hotels, followed by 3-star. Low cost options are ranked lowest. For transportation options, planes are most preferred, followed by bus and trains being the least desirable. Regarding the destination, the most preferred country is Portugal, followed by Spain and then Turkey. Greece is the least desirable destination.

### Willingness to Pay

We can further our interpretation of the model by calculating the willingness to pay for each level's attribute utilizing the 3rd proposed model that treats price as a quantitative attribute. The results represent the monetary value that respondents are willing to pay for changes in each attribute.

```{r,echo=FALSE}
- coef(model3) / coef(model3)["as.numeric(as.character(Price))"]
```

Upon analysis of the results, we find strong preferences on the monetary value respondents place on various vacation attributes. For trip duration, respondents are willing to pay up to €1948.53 more for a 2-night vacation instead of a 5-night vacation and €1312.81 more for a 2-night vacation instead of a 10-night vacation, showing a strong preference for shorter trips. Regarding accommodation, customers value high-end options significantly, being willing to pay €555.56 more for a 3-star hotel over a budget hotel and €2219.09 more for a 5-star hotel over a budget option. In terms of transportation, respondents are willing to pay €848.05 more to fly instead of taking a bus, while preferring a bus over a train by €386.12. Finally, regarding destination preferences, a customer is willing to pay €2817.97 more to visit Portugal over Greece, €1947.53 more to visit Spain over Greece, and €790.83 more to visit Turkey over Greece.

In summary, respondents prefer 2-night vacations, 5-star hotels, plane travel, and destinations like Portugal and Spain, showing a clear willingness to pay more for convenience, luxury, and popular locations.

### (Joaco's Comments)

Given the disparities between the part worths and the WTP tables, it would be fair to assume that we face, on average, a set of respondents with high sensitivity towards cost. That is, on abstract they have certain tastes, but when it comes the time of paying, their choices change a lot.

**COMMENT: Are we saying here that: The first row refers to the company’s planned design, while the other five rows represent the competitors’ products? I am a bit confused with the interpretation of this part. I'll continue with the other stuff and come back later.**

```{r,echo=FALSE}

# Defining the function to predict from the MNL
predict.mnl <- function(model, data) {
  data.model <- model.matrix(update(model$formula, 0 ~ .), data = data)[,-1]
  logitUtility <- data.model%*%model$coef
  share <- exp(logitUtility)/sum(exp(logitUtility))
  cbind(share, data)
}

# Defining the data frame containing the set of possible designs 
attributes <- list(
  Price = unique(vacation$Price),
  Duration = unique(vacation$Duration),
  Accommodation = unique(vacation$Accommodation),
  Transport = unique(vacation$Transport),
  Destination = unique(vacation$Destination)
)
allDesign <- expand.grid(attributes) 
options(max.print = 3000)
allDesign

# 4 heterogeneous designs for each destination
new.data <- allDesign[c(3, 24, 59, 95,
                        115, 146, 200, 205,
                        231, 256, 279, 298,
                        331, 366, 401, 431), ] 
new.data

predict.mnl(model2, new.data)
# why these vacation packages? how we explain the choice?
# if 2 packages are too similar than shares are wrong



```

### Preference Shares

To further assess this,another useful approach to assess the role of product attributes consists on using the model to obtain preference share predictions. By changing the levels’ attributes of the planned design we can observe how variations in the design influence the preference shares.

### Sensitivity Charts

### Modelling: Mixed MNL model

The model includes random coefficients to account for individual heterogeneity in preferences, and the standard deviations of these random coefficients suggest considerable variation across respondents, particularly for price and duration preferences. The likelihood ratio test indicates that the inclusion of random coefficients improves the model's fit significantly, reinforcing the importance of accounting for individual differences in choice behavior. The results suggest that while people,on average, prefer short stay to 10 day stays, a non-negligible fraction of them prefer duration 10 over short stay. The same can be said of 3 star hotels over 5 star hotels. Train over plane. And finally. A non-neglible amount prefer greece. 



```{r,echo=FALSE}

model2.rpar <- rep("n", length=length(model2$coef))
names(model2.rpar) <- names(model2$coef)
model2.rpar


model2.mixed <- mlogit(choice ~ Price + Duration + Accommodation +
                         Transport + Destination | -1, 
                   data = vacation_mlogit, 
                   panel=TRUE, rpar = model2.rpar, correlation = FALSE)
summary(model2.mixed)

# Visual summary of the distribution of random effects and hence of the level of heterogeneity (ERASE THIS COMMENT IN FINAL VERSION)
plot(model2.mixed)
#TO DO: Analyze this plot and understand why its results are so different from the professor's

#"Indeed, the estimated standard deviation for the part worth of 8-seats against
#6-seats of about 0.995 is quite large if compared with the corresponding
#average estimate (of 0.39 in absolute value). This suggests that while people,
#on average, prefer 6 to 8 seats, a non-negligible fraction of them prefer 8
#seats."


```




```{r,echo=FALSE}

#NOTE: Here I leave the code ready to analyze the random effects for each Price variable. 
# We may decide to extend this for all pairs of attribute+level

#1. PRICE 500
Price500.distr <- rpar(model2.mixed, "Price500")
summary(Price500.distr)
mean(Price500.distr)
med(Price500.distr)
plot(Price500.distr)

#2. PRICE 800
Price800.distr <- rpar(model2.mixed, "Price800")
summary(Price800.distr)
mean(Price800.distr)
med(Price800.distr)
plot(Price800.distr)

#3. PRICE 1500
Price1500.distr <- rpar(model2.mixed, "Price1500")
summary(Price1500.distr)
mean(Price1500.distr)
med(Price1500.distr)
plot(Price1500.distr)

#4. PRICE 2500
Price2500.distr <- rpar(model2.mixed, "Price2500")
summary(Price2500.distr)
mean(Price2500.distr)
med(Price2500.distr)
plot(Price2500.distr)
```

###  Correlated Random Coefficients

```{r,echo=FALSE}

# Adding correlated random coefficients
model2.mixed2 <- update(model2.mixed, correlation = TRUE)
summary(model2.mixed2)


#NOTE: This should be placed in the final analysis part.
summary(vcov(model2.mixed2, what = "rpar", type = "cor"))



```





# 7. Managerial Implications and Conclusions

-   Practical implications of the findings for decision-makers.
-   Recommendations for stakeholders (e.g., product development, marketing strategies). Final conclusions summarizing the study.
-   Final conclusions summarizing the study.

# 8. References

-   Cite all references, including academic, literature, data sources, and tools used.
